<div class="payment-history-container">
  <div class="header-section">
    <h1>Payment History</h1>
    <p>View and manage all your payment transactions</p>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">payments</mat-icon>
          <div class="stat-details">
            <h3>{{ getFormattedAmount(totalPaid) }}</h3>
            <p>Total Paid</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">pending</mat-icon>
          <div class="stat-details">
            <h3>{{ getFormattedAmount(pendingPayments) }}</h3>
            <p>Pending Payments</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">event_available</mat-icon>
          <div class="stat-details">
            <h3>{{ getFormattedAmount(attendancePayments) }}</h3>
            <p>Attendance Fees</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">account_balance</mat-icon>
          <div class="stat-details">
            <h3>{{ getFormattedAmount(loanPayments) }}</h3>
            <p>Loan Payments</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filters Section -->
  <mat-card class="filters-section">
    <mat-card-content>
      <div class="filter-controls">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search Payments</mat-label>
          <input matInput [(ngModel)]="searchTerm" (input)="applyFilters()" placeholder="Search by transaction ID or description">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Payment Type</mat-label>
          <mat-select [(value)]="typeFilter" (selectionChange)="applyFilters()">
            <mat-option value="all">All Types</mat-option>
            <mat-option value="attendance">Attendance Fee</mat-option>
            <mat-option value="loan_emi">Loan EMI</mat-option>
            <mat-option value="loan_application">Loan Application</mat-option>
            <mat-option value="savings">Savings</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Status</mat-label>
          <mat-select [(value)]="statusFilter" (selectionChange)="applyFilters()">
            <mat-option value="all">All Status</mat-option>
            <mat-option value="completed">Completed</mat-option>
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="failed">Failed</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Payment Method</mat-label>
          <mat-select [(value)]="methodFilter" (selectionChange)="applyFilters()">
            <mat-option value="all">All Methods</mat-option>
            <mat-option value="upi">UPI</mat-option>
            <mat-option value="cash">Cash</mat-option>
            <mat-option value="bank_transfer">Bank Transfer</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Date Range Filter -->
      <div class="date-range-filters">
        <mat-form-field appearance="outline" class="date-field">
          <mat-label>From Date</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="dateRange.start" (dateChange)="applyFilters()">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="date-field">
          <mat-label>To Date</mat-label>
          <input matInput [matDatepicker]="endPicker" [(ngModel)]="dateRange.end" (dateChange)="applyFilters()">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <button mat-stroked-button (click)="clearFilters()" class="clear-btn">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Payments Table -->
  <mat-card class="payments-table-section">
    <mat-card-header>
      <mat-card-title>Payment Transactions</mat-card-title>
      <span class="results-count">{{ filteredPayments.length }} payments found</span>
    </mat-card-header>

    <mat-card-content>
      <table mat-table [dataSource]="filteredPayments" class="full-width">
        <!-- Transaction ID Column -->
        <ng-container matColumnDef="transactionId">
          <th mat-header-cell *matHeaderCellDef>Transaction ID</th>
          <td mat-cell *matCellDef="let payment">
            <div class="transaction-id">
              <strong>{{ payment.transactionId }}</strong>
              <p class="description">{{ payment.description }}</p>
              <span *ngIf="payment.meetingTitle" class="meeting-title">
                {{ payment.meetingTitle }}
              </span>
              <span *ngIf="payment.loanNumber" class="loan-number">
                Loan: {{ payment.loanNumber }}
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Date Column -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let payment">
            {{ payment.date | date:'mediumDate' }}
          </td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let payment">
            <span class="payment-type">
              {{ getTypeTranslation(payment.type) }}
            </span>
          </td>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Amount</th>
          <td mat-cell *matCellDef="let payment">
            <div class="payment-amount">
              <strong>{{ getFormattedAmount(payment.amount) }}</strong>
            </div>
          </td>
        </ng-container>

        <!-- Method Column -->
        <ng-container matColumnDef="method">
          <th mat-header-cell *matHeaderCellDef>Method</th>
          <td mat-cell *matCellDef="let payment">
            <div class="payment-method">
              <mat-icon>{{ getMethodIcon(payment.method) }}</mat-icon>
              <span>{{ getMethodTranslation(payment.method) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let payment">
            <span [class]="getStatusClass(payment.status)">
              {{ getStatusTranslation(payment.status) }}
            </span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let payment">
            <div class="action-buttons">
              <button mat-icon-button color="primary" [matTooltip]="'View ' + payment.transactionId" (click)="viewPaymentDetails(payment)">
                <mat-icon>visibility</mat-icon>
              </button>
              
              <button mat-icon-button color="accent" [matTooltip]="'Download receipt for ' + payment.transactionId" (click)="downloadReceipt(payment)" [disabled]="payment.status !== 'completed'">
                <mat-icon>receipt</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <!-- Empty State -->
      <div *ngIf="filteredPayments.length === 0" class="empty-state">
        <mat-icon>receipt_long</mat-icon>
        <h3>No payments found</h3>
        <p>Try adjusting your search criteria</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>